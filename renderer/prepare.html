<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React æŠ€æœ¯æ­ç§˜</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="Reactæºç è§£æ">
    <link rel="preload" href="/just-react/assets/css/0.styles.4300949d.css" as="style"><link rel="preload" href="/just-react/assets/js/app.3ca5235f.js" as="script"><link rel="preload" href="/just-react/assets/js/2.ceab786f.js" as="script"><link rel="preload" href="/just-react/assets/js/27.bb7812ac.js" as="script"><link rel="prefetch" href="/just-react/assets/js/10.85a9a20d.js"><link rel="prefetch" href="/just-react/assets/js/11.932b412d.js"><link rel="prefetch" href="/just-react/assets/js/12.f242cd2d.js"><link rel="prefetch" href="/just-react/assets/js/13.03453b62.js"><link rel="prefetch" href="/just-react/assets/js/14.1eca8eb4.js"><link rel="prefetch" href="/just-react/assets/js/15.dc2f6e5e.js"><link rel="prefetch" href="/just-react/assets/js/16.a18f2ae6.js"><link rel="prefetch" href="/just-react/assets/js/17.faab250d.js"><link rel="prefetch" href="/just-react/assets/js/18.5fbf02a3.js"><link rel="prefetch" href="/just-react/assets/js/19.f49e92b5.js"><link rel="prefetch" href="/just-react/assets/js/20.d286fee0.js"><link rel="prefetch" href="/just-react/assets/js/21.048ef0cd.js"><link rel="prefetch" href="/just-react/assets/js/22.6266ec24.js"><link rel="prefetch" href="/just-react/assets/js/23.499ba392.js"><link rel="prefetch" href="/just-react/assets/js/24.bf405dce.js"><link rel="prefetch" href="/just-react/assets/js/25.ce9b9c12.js"><link rel="prefetch" href="/just-react/assets/js/26.b9eeed1a.js"><link rel="prefetch" href="/just-react/assets/js/28.7cf508b5.js"><link rel="prefetch" href="/just-react/assets/js/29.874fb249.js"><link rel="prefetch" href="/just-react/assets/js/3.540ccf28.js"><link rel="prefetch" href="/just-react/assets/js/30.16070aa2.js"><link rel="prefetch" href="/just-react/assets/js/31.f0fa4d21.js"><link rel="prefetch" href="/just-react/assets/js/32.64085e73.js"><link rel="prefetch" href="/just-react/assets/js/33.3aedd51d.js"><link rel="prefetch" href="/just-react/assets/js/34.701196c0.js"><link rel="prefetch" href="/just-react/assets/js/35.c834d299.js"><link rel="prefetch" href="/just-react/assets/js/4.10c8f825.js"><link rel="prefetch" href="/just-react/assets/js/5.e9b9f33b.js"><link rel="prefetch" href="/just-react/assets/js/6.bb2347f8.js"><link rel="prefetch" href="/just-react/assets/js/7.35de3e13.js"><link rel="prefetch" href="/just-react/assets/js/8.fb63fdcd.js"><link rel="prefetch" href="/just-react/assets/js/9.833803a9.js">
    <link rel="stylesheet" href="/just-react/assets/css/0.styles.4300949d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/just-react/" class="home-link router-link-active"><!----> <span class="site-name">React æŠ€æœ¯æ­ç§˜</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/just-react/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·å­¦ä¹ 
</a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/just-react/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·å­¦ä¹ 
</a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/just-react/" aria-current="page" class="sidebar-link">å‰è¨€</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬ä¸€ç«  å‰ç½®çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬äºŒç«  renderé˜¶æ®µ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ç¬¬ä¸‰ç«  commité˜¶æ®µ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/just-react/renderer/prepare.html" aria-current="page" class="active sidebar-link">æµç¨‹æ¦‚è§ˆ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/just-react/renderer/prepare.html#before-mutationä¹‹å‰" class="sidebar-link">before mutationä¹‹å‰</a></li><li class="sidebar-sub-header"><a href="/just-react/renderer/prepare.html#layoutä¹‹å" class="sidebar-link">layoutä¹‹å</a></li></ul></li><li><a href="/just-react/renderer/beforeMutation.html" class="sidebar-link">before mutationé˜¶æ®µ</a></li><li><a href="/just-react/renderer/mutation.html" class="sidebar-link">mutationé˜¶æ®µ</a></li><li><a href="/just-react/renderer/layout.html" class="sidebar-link">layouté˜¶æ®µ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬å››ç«  Diffç®—æ³•</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬äº”ç«  çŠ¶æ€æ›´æ–°</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬å…­ç«  Hooks</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>ä¸Šä¸€ç« <a href="/just-react/process/completeWork.html#æµç¨‹ç»“å°¾">æœ€åä¸€èŠ‚</a>æˆ‘ä»¬ä»‹ç»äº†ï¼Œ<code>commitRoot</code>æ–¹æ³•æ˜¯<code>commité˜¶æ®µ</code>å·¥ä½œçš„èµ·ç‚¹ã€‚<code>rootFiber</code>ä¼šä½œä¸ºä¼ å‚ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>åœ¨<code>rootFiber.firstEffect</code>ä¸Šä¿å­˜äº†ä¸€æ¡éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„<code>FiberèŠ‚ç‚¹</code>çš„å•å‘é“¾è¡¨<code>effectList</code>ï¼Œè¿™äº›<code>FiberèŠ‚ç‚¹</code>çš„<code>updateQueue</code>ä¸­ä¿å­˜äº†å˜åŒ–çš„<code>props</code>ã€‚è¿™äº›éƒ½éœ€è¦åœ¨<code>commit</code>é˜¶æ®µè¢«æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚</p> <p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰äº›ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆæ¯”å¦‚<code>componentDidXXX</code>ï¼‰ã€<code>hook</code>ï¼ˆæ¯”å¦‚<code>useEffect</code>ï¼‰éœ€è¦åœ¨<code>commit</code>é˜¶æ®µæ‰§è¡Œã€‚</p> <p><code>commit</code>é˜¶æ®µçš„ä¸»è¦å·¥ä½œï¼ˆå³<code>Renderer</code>çš„å·¥ä½œæµç¨‹ï¼‰åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p> <ul><li><p>before mutationé˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œå‰ï¼‰</p></li> <li><p>mutationé˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œï¼‰</p></li> <li><p>layouté˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œåï¼‰</p></li></ul> <p>ä½ å¯ä»¥ä»<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1852" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>çœ‹åˆ°<code>commit</code>é˜¶æ®µçš„å®Œæ•´ä»£ç </p> <p>åœ¨<code>before mutationé˜¶æ®µ</code>ä¹‹å‰å’Œ<code>layouté˜¶æ®µ</code>ä¹‹åè¿˜æœ‰ä¸€äº›é¢å¤–å·¥ä½œï¼Œæ¶‰åŠåˆ°æ¯”å¦‚<code>useEffect</code>çš„è§¦å‘ï¼Œ<code>ä¼˜å…ˆçº§ç›¸å…³</code>çš„é‡ç½®ã€‚å¯¹æˆ‘ä»¬å½“å‰å±äºè¶…çº²å†…å®¹ï¼Œä¸ºäº†å†…å®¹å®Œæ•´æ€§ï¼Œåœ¨è¿™èŠ‚ä¸­ç®€å•ä»‹ç»ã€‚</p> <h2 id="before-mutationä¹‹å‰"><a href="#before-mutationä¹‹å‰" class="header-anchor">#</a> before mutationä¹‹å‰</h2> <p><code>commitRootImpl</code>æ–¹æ³•ä¸­ç›´åˆ°ç¬¬ä¸€å¥<code>if (firstEffect !== null)</code>ä¹‹å‰å±äº<code>before mutationä¹‹å‰</code>ã€‚</p> <p>æˆ‘ä»¬å¤§ä½“çœ‹ä¸‹ä»–åšçš„å·¥ä½œï¼Œç°åœ¨ä½ è¿˜ä¸éœ€è¦ç†è§£ä»–ä»¬ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// è§¦å‘useEffectå›è°ƒä¸å…¶ä»–åŒæ­¥ä»»åŠ¡ã€‚ç”±äºè¿™äº›ä»»åŠ¡å¯èƒ½è§¦å‘æ–°çš„æ¸²æŸ“ï¼Œæ‰€ä»¥è¿™é‡Œè¦ä¸€ç›´éå†æ‰§è¡Œç›´åˆ°æ²¡æœ‰ä»»åŠ¡</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// å³ rootFiber</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token comment">// å‡¡æ˜¯å˜é‡åå¸¦laneçš„éƒ½æ˜¯ä¼˜å…ˆçº§ç›¸å…³</span>
  <span class="token keyword">const</span> lanes <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedLanes<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token comment">// é‡ç½®Schedulerç»‘å®šçš„å›è°ƒå‡½æ•°</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackId <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">let</span> remainingLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>childLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// é‡ç½®ä¼˜å…ˆçº§ç›¸å…³å˜é‡</span>
  <span class="token function">markRootFinished</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> remainingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ¸…é™¤å·²å®Œæˆçš„discrete updatesï¼Œä¾‹å¦‚ï¼šç”¨æˆ·é¼ æ ‡ç‚¹å‡»è§¦å‘çš„æ›´æ–°ã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootsWithPendingDiscreteUpdates <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token function">hasDiscreteLanes</span><span class="token punctuation">(</span>remainingLanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å°†effectListèµ‹å€¼ç»™firstEffect</span>
  <span class="token comment">// ç”±äºæ¯ä¸ªfiberçš„effectListåªåŒ…å«ä»–çš„å­å­™èŠ‚ç‚¹</span>
  <span class="token comment">// æ‰€ä»¥æ ¹èŠ‚ç‚¹å¦‚æœæœ‰effectTagåˆ™ä¸ä¼šè¢«åŒ…å«è¿›æ¥</span>
  <span class="token comment">// æ‰€ä»¥è¿™é‡Œå°†æœ‰effectTagçš„æ ¹èŠ‚ç‚¹æ’å…¥åˆ°effectListå°¾éƒ¨</span>
  <span class="token comment">// è¿™æ ·æ‰èƒ½ä¿è¯æœ‰effectçš„fiberéƒ½åœ¨effectListä¸­</span>
  <span class="token keyword">let</span> firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&gt;</span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      finishedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ¹èŠ‚ç‚¹æ²¡æœ‰effectTag</span>
    firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>before mutation</code>ä¹‹å‰ä¸»è¦åšä¸€äº›å˜é‡èµ‹å€¼çš„å‡†å¤‡å·¥ä½œã€‚è¿™ä¸€é•¿ä¸²ä»£ç æˆ‘ä»¬åªéœ€è¦å…³æ³¨æœ€åèµ‹å€¼çš„<code>firstEffect</code>ï¼Œåœ¨<code>commit</code>çš„ä¸‰ä¸ªé˜¶æ®µéƒ½ä¼šç”¨åˆ°ä»–ã€‚</p> <h2 id="layoutä¹‹å"><a href="#layoutä¹‹å" class="header-anchor">#</a> layoutä¹‹å</h2> <p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ç®€å•çœ‹ä¸‹<code>layout</code>é˜¶æ®µæ‰§è¡Œå®Œåçš„ä»£ç ï¼Œç°åœ¨ä½ è¿˜ä¸éœ€è¦ç†è§£ä»–ä»¬ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">// å¤„ç†useEffectç›¸å…³</span>
<span class="token keyword">const</span> rootDidHavePassiveEffects <span class="token operator">=</span> rootDoesHavePassiveEffects<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  rootWithPendingPassiveEffects <span class="token operator">=</span> root<span class="token punctuation">;</span>
  pendingPassiveEffectsLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
  pendingPassiveEffectsRenderPriority <span class="token operator">=</span> renderPriorityLevel<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nextNextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
    nextEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Deletion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">detachFiberAfterEffects</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextNextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

remainingLanes <span class="token operator">=</span> root<span class="token punctuation">.</span>pendingLanes<span class="token punctuation">;</span>

<span class="token comment">// æ€§èƒ½è¿½è¸ªç›¸å…³</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>remainingLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spawnedWorkDuringRender <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> expirationTimes <span class="token operator">=</span> spawnedWorkDuringRender<span class="token punctuation">;</span>
      spawnedWorkDuringRender <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> expirationTimes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">scheduleInteractions</span><span class="token punctuation">(</span>
          root<span class="token punctuation">,</span>
          expirationTimes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          root<span class="token punctuation">.</span>memoizedInteractions<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">schedulePendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> remainingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  legacyErrorBoundariesThatAlreadyFailed <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ€§èƒ½è¿½è¸ªç›¸å…³</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDidHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">finishPendingInteractions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ£€æµ‹æ— é™å¾ªç¯æ¸²æŸ“</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>remainingLanes <span class="token operator">===</span> SyncLane<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> rootWithNestedUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nestedUpdateCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    nestedUpdateCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rootWithNestedUpdates <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  nestedUpdateCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// åœ¨ç¦»å¼€commitRootå‡½æ•°å‰è°ƒç”¨ï¼Œç¡®ä¿ä»»ä½•é™„åŠ çš„ä»»åŠ¡è¢«è°ƒåº¦</span>
<span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è®°å½•é”™è¯¯</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>hasUncaughtError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hasUncaughtError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> error <span class="token operator">=</span> firstUncaughtError<span class="token punctuation">;</span>
  firstUncaughtError <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// é—ç•™çš„è¾¹ç•Œæƒ…å†µ</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// åœ¨commité˜¶æ®µæœ‰åŒæ­¥ä»»åŠ¡è¢«è°ƒåº¦ï¼Œåœ¨è¿™é‡Œç‡å…ˆæ‰§è¡Œä»–ä»¬ï¼Œä¸éœ€è¦ç­‰åˆ°æµè§ˆå™¨ä¸‹ä¸€ä¸ªmacroTask</span>
<span class="token comment">// æ¯”å¦‚åœ¨ componentDidMount ä¸­æ‰§è¡Œ setState åˆ›å»ºçš„æ›´æ–°ä¼šåœ¨è¿™é‡Œè¢«åŒæ­¥æ‰§è¡Œ</span>
<span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸»è¦åŒ…æ‹¬ä¸‰ç‚¹å†…å®¹ï¼š</p> <ol><li><code>useEffect</code>ç›¸å…³çš„å¤„ç†ã€‚</li></ol> <p>è¿™ç‚¹æˆ‘ä»¬ä¼šåœ¨è®²è§£<code>layouté˜¶æ®µ</code>æ—¶ä¸€èµ·è®²è§£ã€‚</p> <ol start="2"><li>æ€§èƒ½è¿½è¸ªç›¸å…³ã€‚</li></ol> <p>æºç é‡Œæœ‰å¾ˆå¤šå’Œ<code>interaction</code>ç›¸å…³çš„å˜é‡ã€‚ä»–ä»¬éƒ½å’Œè¿½è¸ª<code>React</code>æ¸²æŸ“æ—¶é—´ã€æ€§èƒ½ç›¸å…³ã€‚è¢«ç”¨åœ¨<a href="https://reactjs.bootcss.com/docs/profiler.html" target="_blank" rel="noopener noreferrer">Profiler API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>å’Œ<a href="https://github.com/facebook/react-devtools/pull/1069" target="_blank" rel="noopener noreferrer">DevTools<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ä¸­ã€‚</p> <blockquote><p>ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°<a href="https://gist.github.com/bvaughn/8de925562903afd2e7a12554adcdda16#overview" target="_blank" rel="noopener noreferrer">interactionçš„å®šä¹‰<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</p></blockquote> <ol start="3"><li>åœ¨<code>commit</code>é˜¶æ®µä¼šè§¦å‘ä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¦‚ <code>componentDidXXX</code>ï¼‰å’Œ<code>hook</code>ï¼ˆå¦‚<code>useLayoutEffect</code>ã€<code>useEffect</code>ï¼‰ã€‚</li></ol> <p>åœ¨è¿™äº›å›è°ƒæ–¹æ³•ä¸­å¯èƒ½è§¦å‘æ–°çš„æ›´æ–°ï¼Œæ–°çš„æ›´æ–°ä¼šå¼€å¯æ–°çš„<code>render-commit</code>æµç¨‹ã€‚è€ƒè™‘å¦‚ä¸‹Demoï¼š</p> <details class="custom-block details"><summary>useLayoutEffect Demo</summary> <p>åœ¨è¯¥Demoä¸­æˆ‘ä»¬ç‚¹å‡»é¡µé¢ä¸­çš„æ•°å­—ï¼ŒçŠ¶æ€ä¼šå…ˆå˜ä¸º0ï¼Œå†åœ¨<code>useLayoutEffect</code>å›è°ƒä¸­å˜ä¸ºéšæœºæ•°ã€‚ä½†åœ¨é¡µé¢ä¸Šæ•°å­—ä¸ä¼šå˜ä¸º0ï¼Œè€Œæ˜¯ç›´æ¥å˜ä¸ºæ–°çš„éšæœºæ•°ã€‚</p> <p>è¿™æ˜¯å› ä¸º<code>useLayoutEffect</code>ä¼šåœ¨<code>layouté˜¶æ®µ</code>åŒæ­¥æ‰§è¡Œå›è°ƒã€‚å›è°ƒä¸­æˆ‘ä»¬è§¦å‘äº†çŠ¶æ€æ›´æ–°<code>setCount(randomNum)</code>ï¼Œè¿™ä¼šé‡æ–°è°ƒåº¦ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ã€‚</p> <p>è¯¥ä»»åŠ¡ä¼šåœ¨åœ¨å¦‚ä¸Š<code>commitRoot</code>å€’æ•°ç¬¬äºŒè¡Œä»£ç å¤„è¢«åŒæ­¥æ‰§è¡Œã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æ‰€ä»¥æˆ‘ä»¬çœ‹ä¸åˆ°é¡µé¢ä¸­å…ƒç´ å…ˆå˜ä¸º0ã€‚</p> <p><a href="https://code.h5jun.com/vazos/edit?html,js,output" target="_blank" rel="noopener noreferrer">Demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></details></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/BetaSu/just-react/edit/master/docs/renderer/prepare.md" target="_blank" rel="noopener noreferrer">ä¸ºè¯¥ç« èŠ‚çº é”™</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">7/22/2020, 4:09:32 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/just-react/process/completeWork.html" class="prev">
        completeWork
      </a></span> <span class="next"><a href="/just-react/renderer/beforeMutation.html">
        before mutationé˜¶æ®µ
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/just-react/assets/js/app.3ca5235f.js" defer></script><script src="/just-react/assets/js/2.ceab786f.js" defer></script><script src="/just-react/assets/js/27.bb7812ac.js" defer></script>
  </body>
</html>
