<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React æŠ€æœ¯æ­ç§˜</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="Reactæºç è§£æ">
    <link rel="preload" href="/just-react/assets/css/0.styles.4300949d.css" as="style"><link rel="preload" href="/just-react/assets/js/app.3ca5235f.js" as="script"><link rel="preload" href="/just-react/assets/js/2.ceab786f.js" as="script"><link rel="preload" href="/just-react/assets/js/24.bf405dce.js" as="script"><link rel="prefetch" href="/just-react/assets/js/10.85a9a20d.js"><link rel="prefetch" href="/just-react/assets/js/11.932b412d.js"><link rel="prefetch" href="/just-react/assets/js/12.f242cd2d.js"><link rel="prefetch" href="/just-react/assets/js/13.03453b62.js"><link rel="prefetch" href="/just-react/assets/js/14.1eca8eb4.js"><link rel="prefetch" href="/just-react/assets/js/15.dc2f6e5e.js"><link rel="prefetch" href="/just-react/assets/js/16.a18f2ae6.js"><link rel="prefetch" href="/just-react/assets/js/17.faab250d.js"><link rel="prefetch" href="/just-react/assets/js/18.5fbf02a3.js"><link rel="prefetch" href="/just-react/assets/js/19.f49e92b5.js"><link rel="prefetch" href="/just-react/assets/js/20.d286fee0.js"><link rel="prefetch" href="/just-react/assets/js/21.048ef0cd.js"><link rel="prefetch" href="/just-react/assets/js/22.6266ec24.js"><link rel="prefetch" href="/just-react/assets/js/23.499ba392.js"><link rel="prefetch" href="/just-react/assets/js/25.ce9b9c12.js"><link rel="prefetch" href="/just-react/assets/js/26.b9eeed1a.js"><link rel="prefetch" href="/just-react/assets/js/27.bb7812ac.js"><link rel="prefetch" href="/just-react/assets/js/28.7cf508b5.js"><link rel="prefetch" href="/just-react/assets/js/29.874fb249.js"><link rel="prefetch" href="/just-react/assets/js/3.540ccf28.js"><link rel="prefetch" href="/just-react/assets/js/30.16070aa2.js"><link rel="prefetch" href="/just-react/assets/js/31.f0fa4d21.js"><link rel="prefetch" href="/just-react/assets/js/32.64085e73.js"><link rel="prefetch" href="/just-react/assets/js/33.3aedd51d.js"><link rel="prefetch" href="/just-react/assets/js/34.701196c0.js"><link rel="prefetch" href="/just-react/assets/js/35.c834d299.js"><link rel="prefetch" href="/just-react/assets/js/4.10c8f825.js"><link rel="prefetch" href="/just-react/assets/js/5.e9b9f33b.js"><link rel="prefetch" href="/just-react/assets/js/6.bb2347f8.js"><link rel="prefetch" href="/just-react/assets/js/7.35de3e13.js"><link rel="prefetch" href="/just-react/assets/js/8.fb63fdcd.js"><link rel="prefetch" href="/just-react/assets/js/9.833803a9.js">
    <link rel="stylesheet" href="/just-react/assets/css/0.styles.4300949d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/just-react/" class="home-link router-link-active"><!----> <span class="site-name">React æŠ€æœ¯æ­ç§˜</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/just-react/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·å­¦ä¹ 
</a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/just-react/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·å­¦ä¹ 
</a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/just-react/" aria-current="page" class="sidebar-link">å‰è¨€</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬ä¸€ç«  å‰ç½®çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬äºŒç«  renderé˜¶æ®µ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ç¬¬ä¸‰ç«  commité˜¶æ®µ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/just-react/renderer/prepare.html" class="sidebar-link">æµç¨‹æ¦‚è§ˆ</a></li><li><a href="/just-react/renderer/beforeMutation.html" aria-current="page" class="active sidebar-link">before mutationé˜¶æ®µ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/just-react/renderer/beforeMutation.html#æ¦‚è§ˆ" class="sidebar-link">æ¦‚è§ˆ</a></li><li class="sidebar-sub-header"><a href="/just-react/renderer/beforeMutation.html#commitbeforemutationeffects" class="sidebar-link">commitBeforeMutationEffects</a></li><li class="sidebar-sub-header"><a href="/just-react/renderer/beforeMutation.html#è°ƒç”¨getsnapshotbeforeupdate" class="sidebar-link">è°ƒç”¨getSnapshotBeforeUpdate</a></li><li class="sidebar-sub-header"><a href="/just-react/renderer/beforeMutation.html#è°ƒåº¦useeffect" class="sidebar-link">è°ƒåº¦useEffect</a></li><li class="sidebar-sub-header"><a href="/just-react/renderer/beforeMutation.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li><li><a href="/just-react/renderer/mutation.html" class="sidebar-link">mutationé˜¶æ®µ</a></li><li><a href="/just-react/renderer/layout.html" class="sidebar-link">layouté˜¶æ®µ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬å››ç«  Diffç®—æ³•</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬äº”ç«  çŠ¶æ€æ›´æ–°</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç¬¬å…­ç«  Hooks</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>åœ¨æœ¬èŠ‚æ­£å¼å¼€å§‹å‰ï¼Œè®©æˆ‘ä»¬å¤ä¹ ä¸‹è¿™ä¸€ç« åˆ°ç›®å‰ä¸ºæ­¢æ‰€å­¦çš„ã€‚</p> <p><code>Renderer</code>å·¥ä½œçš„é˜¶æ®µè¢«ç§°ä¸º<code>commit</code>é˜¶æ®µã€‚<code>commit</code>é˜¶æ®µå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼š</p> <ul><li><p>before mutationé˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œå‰ï¼‰</p></li> <li><p>mutationé˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œï¼‰</p></li> <li><p>layouté˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œåï¼‰</p></li></ul> <p>æœ¬èŠ‚æˆ‘ä»¬çœ‹çœ‹<code>before mutationé˜¶æ®µ</code>ï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œå‰ï¼‰éƒ½åšäº†ä»€ä¹ˆã€‚</p> <h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="header-anchor">#</a> æ¦‚è§ˆ</h2> <p><code>before mutationé˜¶æ®µ</code>çš„ä»£ç å¾ˆçŸ­ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯éå†<code>effectList</code>å¹¶è°ƒç”¨<code>commitBeforeMutationEffects</code>å‡½æ•°å¤„ç†ã€‚</p> <blockquote><p>è¿™éƒ¨åˆ†<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1956" target="_blank" rel="noopener noreferrer">æºç åœ¨è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚ä¸ºäº†å¢åŠ å¯è¯»æ€§ï¼Œç¤ºä¾‹ä»£ç ä¸­åˆ é™¤äº†ä¸ç›¸å…³çš„é€»è¾‘</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äº<code>commit</code>çš„ä¸‰ä¸ªé˜¶æ®µéƒ½ä¼šéå†<code>effectList</code>ï¼Œæ‰€ä»¥è¿™é‡Œå°†<code>effectList</code>çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹<code>firstEffect</code>èµ‹å€¼ç»™<code>nextEffect</code>æ–¹ä¾¿åé¢å¤ç”¨ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
</code></pre></div><p>è®©æˆ‘ä»¬çœ‹çœ‹<code>commitBeforeMutationEffects</code>åšäº†ä»€ä¹ˆã€‚</p> <h2 id="commitbeforemutationeffects"><a href="#commitbeforemutationeffects" class="header-anchor">#</a> commitBeforeMutationEffects</h2> <p>å¤§ä½“ä»£ç é€»è¾‘ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    <span class="token comment">// å¤„ç†DOMèŠ‚ç‚¹æ¸²æŸ“/åˆ é™¤åçš„ autoFocusã€blur é€»è¾‘</span>
    <span class="token comment">// ...çœç•¥</span>

    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentDebugFiberInDEV</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è°ƒç”¨getSnapshotBeforeUpdate</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">resetCurrentDebugFiberInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å­˜åœ¨useEffectï¼Œè°ƒåº¦ä»–</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// è§¦å‘useEffect</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ•´ä½“å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p> <ol><li><p>å¤„ç†<code>DOMèŠ‚ç‚¹</code>æ¸²æŸ“/åˆ é™¤åçš„ <code>autoFocus</code>ã€<code>blur</code> é€»è¾‘ã€‚</p></li> <li><p>è°ƒç”¨<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚</p></li> <li><p>è°ƒåº¦<code>useEffect</code>ã€‚</p></li></ol> <p>æˆ‘ä»¬è®²è§£ä¸‹2ã€3ä¸¤ç‚¹ã€‚</p> <h2 id="è°ƒç”¨getsnapshotbeforeupdate"><a href="#è°ƒç”¨getsnapshotbeforeupdate" class="header-anchor">#</a> è°ƒç”¨<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L269" target="_blank" rel="noopener noreferrer"><code>getSnapshotBeforeUpdate</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h2> <p>ä»<code>React</code>v16å¼€å§‹ï¼Œ<code>componentWillXXX</code>é’©å­å‰å¢åŠ äº†<code>UNSAFE_</code>å‰ç¼€ã€‚</p> <p>ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸º<code>Stack Reconciler</code>é‡æ„ä¸º<code>Fiber Reconciler</code>åï¼Œ<code>renderé˜¶æ®µ</code>çš„ä»»åŠ¡å¯èƒ½ä¸­æ–­/é‡æ–°å¼€å§‹ï¼Œå¯¹åº”çš„ç»„ä»¶åœ¨<code>renderé˜¶æ®µ</code>çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå³<code>componentWillXXX</code>ï¼‰å¯èƒ½è§¦å‘å¤šæ¬¡ã€‚è¿™ç§è¡Œä¸ºå’Œ<code>React</code>v15ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æ ‡è®°ä¸º<code>UNSAFE_</code>ã€‚</p> <p>ä¸ºæ­¤ï¼Œ<code>React</code>æä¾›äº†æ›¿ä»£çš„ç”Ÿå‘½å‘¨æœŸé’©å­<code>getSnapshotBeforeUpdate</code>ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œ<code>getSnapshotBeforeUpdate</code>æ˜¯åœ¨<code>commité˜¶æ®µ</code>å†…çš„<code>before mutationé˜¶æ®µ</code>è°ƒç”¨çš„ï¼Œç”±äº<code>commité˜¶æ®µ</code>æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ä¸ä¼šé‡åˆ°å¤šæ¬¡è°ƒç”¨çš„é—®é¢˜ã€‚</p> <h2 id="è°ƒåº¦useeffect"><a href="#è°ƒåº¦useeffect" class="header-anchor">#</a> è°ƒåº¦<code>useEffect</code></h2> <p>åœ¨è¿™å‡ è¡Œä»£ç å†…ï¼Œ<code>scheduleCallback</code>æ–¹æ³•ç”±<code>scheduler</code>åŒ…æä¾›ï¼Œç”¨äºå¼‚æ­¥è°ƒåº¦ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å­˜åœ¨useEffectï¼Œè°ƒåº¦ä»–</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// è§¦å‘useEffect</span>
      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ­¤å¤„ï¼Œè¢«å¼‚æ­¥è°ƒåº¦çš„å›è°ƒå‡½æ•°å°±æ˜¯è§¦å‘<code>useEffect</code>çš„æ–¹æ³•<code>flushPassiveEffects</code>ã€‚</p> <p>æˆ‘ä»¬æ¥ä¸‹æ¥è®¨è®ºä¸‹<code>useEffect</code>å¦‚ä½•è¢«å¼‚æ­¥è°ƒåº¦ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦å¼‚æ­¥ï¼ˆè€Œä¸æ˜¯åŒæ­¥ï¼‰è°ƒåº¦ã€‚</p> <h3 id="å¦‚ä½•å¼‚æ­¥è°ƒåº¦"><a href="#å¦‚ä½•å¼‚æ­¥è°ƒåº¦" class="header-anchor">#</a> å¦‚ä½•å¼‚æ­¥è°ƒåº¦</h3> <p>åœ¨<code>flushPassiveEffects</code>æ–¹æ³•å†…éƒ¨ä¼šä»å…¨å±€å˜é‡<code>rootWithPendingPassiveEffects</code>è·å–<code>effectList</code>ã€‚</p> <p>åœ¨<a href="/just-react/process/completeWork.html#effectlist">completeWorkä¸€èŠ‚</a>æˆ‘ä»¬è®²åˆ°ï¼Œ<code>effectList</code>ä¸­ä¿å­˜äº†éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„<code>FiberèŠ‚ç‚¹</code>ã€‚å…¶ä¸­å‰¯ä½œç”¨åŒ…æ‹¬</p> <ul><li>æ’å…¥<code>DOMèŠ‚ç‚¹</code>ï¼ˆPlacementï¼‰</li> <li>æ›´æ–°<code>DOMèŠ‚ç‚¹</code>ï¼ˆUpdateï¼‰</li> <li>åˆ é™¤<code>DOMèŠ‚ç‚¹</code>ï¼ˆDeletionï¼‰</li></ul> <p>é™¤æ­¤å¤–ï¼Œå½“ä¸€ä¸ª<code>FunctionComponent</code>å«æœ‰<code>useEffect</code>æˆ–<code>useLayoutEffect</code>ï¼Œä»–å¯¹åº”çš„<code>FiberèŠ‚ç‚¹</code>ä¹Ÿä¼šè¢«èµ‹å€¼<code>effectTag</code>ã€‚</p> <blockquote><p>ä½ å¯ä»¥ä»<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactHookEffectTags.js" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>çœ‹åˆ°<code>hook</code>ç›¸å…³çš„<code>effectTag</code></p></blockquote> <p>æ‰€ä»¥åœ¨<code>flushPassiveEffects</code>æ–¹æ³•å†…éƒ¨ä¼šéå†<code>rootWithPendingPassiveEffects</code>ï¼ˆå³<code>effectList</code>ï¼‰æ‰§è¡Œ<code>effect</code>å›è°ƒå‡½æ•°ã€‚è€Œæ­¤æ—¶<code>rootWithPendingPassiveEffects === null</code>ã€‚</p> <p>é‚£ä¹ˆ<code>rootWithPendingPassiveEffects</code>ä¼šåœ¨ä½•æ—¶èµ‹å€¼å‘¢ï¼Ÿ</p> <p>åœ¨ä¸Šä¸€èŠ‚<code>layoutä¹‹å</code>çš„ä»£ç ç‰‡æ®µä¸­ä¼šæ ¹æ®<code>rootDoesHavePassiveEffects === true?</code>å†³å®šæ˜¯å¦èµ‹å€¼<code>rootWithPendingPassiveEffects</code>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> rootDidHavePassiveEffects <span class="token operator">=</span> rootDoesHavePassiveEffects<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  rootWithPendingPassiveEffects <span class="token operator">=</span> root<span class="token punctuation">;</span>
  pendingPassiveEffectsLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
  pendingPassiveEffectsRenderPriority <span class="token operator">=</span> renderPriorityLevel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰€ä»¥æ•´ä¸ª<code>useEffect</code>å¼‚æ­¥è°ƒç”¨åˆ†ä¸ºä¸‰æ­¥ï¼š</p> <ol><li><code>before mutationé˜¶æ®µ</code>åœ¨<code>scheduleCallback</code>ä¸­è°ƒåº¦<code>flushPassiveEffects</code></li> <li><code>layouté˜¶æ®µ</code>ä¹‹åå°†<code>effectList</code>èµ‹å€¼ç»™<code>rootWithPendingPassiveEffects</code></li> <li><code>scheduleCallback</code>è§¦å‘<code>flushPassiveEffects</code>ï¼Œ<code>flushPassiveEffects</code>å†…éƒ¨éå†<code>rootWithPendingPassiveEffects</code></li></ol> <h3 id="ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨" class="header-anchor">#</a> ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨</h3> <p>æ‘˜å½•è‡ª<code>React</code>æ–‡æ¡£<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects" target="_blank" rel="noopener noreferrer">effect çš„æ‰§è¡Œæ—¶æœº<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼š</p> <blockquote><p>ä¸ componentDidMountã€componentDidUpdate ä¸åŒçš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶ä¹‹åï¼Œä¼ ç»™ useEffect çš„å‡½æ•°ä¼šå»¶è¿Ÿè°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®è®¢é˜…å’Œäº‹ä»¶å¤„ç†ç­‰æƒ…å†µï¼Œå› æ­¤ä¸åº”åœ¨å‡½æ•°ä¸­æ‰§è¡Œé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•çš„æ“ä½œã€‚</p></blockquote> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>ç»è¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“äº†åœ¨<code>before mutationé˜¶æ®µ</code>ï¼Œä¼šéå†<code>effectList</code>ï¼Œä¾æ¬¡æ‰§è¡Œï¼š</p> <ol><li><p>å¤„ç†<code>DOMèŠ‚ç‚¹</code>æ¸²æŸ“/åˆ é™¤åçš„ <code>autoFocus</code>ã€<code>blur</code>é€»è¾‘</p></li> <li><p>è°ƒç”¨<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸé’©å­</p></li> <li><p>è°ƒåº¦<code>useEffect</code></p></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/BetaSu/just-react/edit/master/docs/renderer/beforeMutation.md" target="_blank" rel="noopener noreferrer">ä¸ºè¯¥ç« èŠ‚çº é”™</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">7/20/2020, 10:40:41 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/just-react/renderer/prepare.html" class="prev">
        æµç¨‹æ¦‚è§ˆ
      </a></span> <span class="next"><a href="/just-react/renderer/mutation.html">
        mutationé˜¶æ®µ
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/just-react/assets/js/app.3ca5235f.js" defer></script><script src="/just-react/assets/js/2.ceab786f.js" defer></script><script src="/just-react/assets/js/24.bf405dce.js" defer></script>
  </body>
</html>
